<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±è¯­é…éŸ³ä¹å›­ - åå°ç®¡ç†</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF6B35;
            --primary-dark: #E55A2B;
            --secondary: #7C3AED;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --bg: #FFFBF5;
            --bg-secondary: #FFF7ED;
            --card: #FFFFFF;
            --text: #1F2937;
            --text-secondary: #6B7280;
            --border: #FED7AA;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* ç™»å½•é¡µé¢ */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }

        .login-box {
            background: var(--card);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-header .logo {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .login-header h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }

        .login-header p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text);
        }

        .login-form .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s;
        }

        .login-form .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
        }

        .login-form .btn-login {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .login-form .btn-login:hover {
            background: var(--primary-dark);
        }

        .login-form .btn-login:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
        }

        .login-error {
            background: #FEE2E2;
            color: #991B1B;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* ä¸»åº”ç”¨æ ·å¼ */
        .app-container {
            display: none;
        }

        .app-container.show {
            display: block;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .navbar {
            background: var(--primary);
            color: white;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .navbar h1 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .navbar-right {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .navbar-stats {
            display: flex;
            gap: 24px;
            font-size: 14px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-value {
            font-weight: 600;
            font-size: 18px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-info span {
            font-size: 14px;
        }

        .btn-logout {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* ä¸»å¸ƒå±€ */
        .main-container {
            display: flex;
            min-height: calc(100vh - 60px);
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 240px;
            background: var(--card);
            border-right: 1px solid var(--border);
            padding: 20px 0;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
        }

        .sidebar-menu li:hover {
            background: var(--bg-secondary);
        }

        .sidebar-menu li.active {
            background: var(--bg-secondary);
            color: var(--primary);
            border-right: 3px solid var(--primary);
            font-weight: 500;
        }

        .sidebar-menu li .icon {
            font-size: 18px;
        }

        /* å†…å®¹åŒºåŸŸ */
        .content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .content-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .content-header h2 {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        /* æŒ‰é’® */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-outline:hover {
            background: var(--bg-secondary);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* å¡ç‰‡ */
        .card {
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
        }

        /* è¡¨æ ¼ */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-secondary);
            font-weight: 500;
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        tr:hover {
            background: var(--bg-secondary);
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #D1FAE5;
            color: #065F46;
        }

        .badge-warning {
            background: #FEF3C7;
            color: #92400E;
        }

        .badge-danger {
            background: #FEE2E2;
            color: #991B1B;
        }

        /* è¡¨å• */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text);
        }

        .form-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        textarea.form-input {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--card);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: all 0.3s;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .stat-card .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-card .stat-info h3 {
            font-size: 28px;
            font-weight: 700;
        }

        .stat-card .stat-info p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* æ ‘å½¢ç›®å½•æ ·å¼ */
        .tree-container {
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .tree-item {
            border-bottom: 1px solid var(--border);
        }

        .tree-item:last-child {
            border-bottom: none;
        }

        .tree-header {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .tree-header:hover {
            background: var(--bg-secondary);
        }

        /* æ’åºæ§ä»¶ */
        .sort-controls {
            display: flex;
            flex-direction: column;
            margin-right: 8px;
            gap: 2px;
        }

        .btn-sort {
            width: 24px;
            height: 16px;
            border: 1px solid var(--border);
            background: var(--card);
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-sort:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* é¦–é¡µå‹¾é€‰æ¡† */
        .featured-checkbox {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 12px;
            cursor: pointer;
            user-select: none;
        }

        .featured-checkbox input {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--warning);
        }

        .featured-checkbox span {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .tree-toggle {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            transition: transform 0.2s;
        }

        .tree-toggle.expanded {
            transform: rotate(90deg);
        }

        .tree-icon {
            font-size: 20px;
            margin-right: 12px;
        }

        .tree-info {
            flex: 1;
        }

        .tree-title {
            font-weight: 600;
            font-size: 15px;
        }

        .tree-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .tree-actions {
            display: flex;
            gap: 8px;
        }

        .tree-children {
            display: none;
            padding-left: 20px;
            background: var(--bg-secondary);
        }

        .tree-children.expanded {
            display: block;
        }

        .tree-child {
            border-bottom: 1px solid var(--border);
        }

        .tree-child:last-child {
            border-bottom: none;
        }

        .tree-child .tree-header {
            padding: 12px 20px;
        }

        .tree-grandchildren {
            display: none;
            padding-left: 20px;
            background: rgba(0,0,0,0.02);
        }

        .tree-grandchildren.expanded {
            display: block;
        }

        .tree-grandchild {
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .tree-grandchild:last-child {
            border-bottom: none;
        }

        .tree-grandchild .tree-header {
            padding: 10px 20px;
        }

        .tree-clips {
            display: none;
            padding: 12px 20px;
            background: rgba(0,0,0,0.03);
        }

        .tree-clips.expanded {
            display: block;
        }

        .clip-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: var(--card);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .clip-item:last-child {
            margin-bottom: 0;
        }

        .clip-order {
            width: 28px;
            height: 28px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            margin-right: 12px;
        }

        .clip-info {
            flex: 1;
        }

        .clip-text {
            font-size: 14px;
            color: var(--text);
        }

        .clip-translation {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .clip-meta {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* ç¼©ç•¥å›¾ */
        .thumbnail {
            width: 60px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
            background: var(--bg-secondary);
            margin-right: 12px;
        }

        /* æ“ä½œæŒ‰é’®ç»„ */
        .action-btns {
            display: flex;
            gap: 8px;
        }

        /* éšè— */
        .hidden {
            display: none !important;
        }

        /* åŠ è½½ä¸­ */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-state p {
            font-size: 16px;
            margin-bottom: 20px;
        }

        /* æ–‡ä»¶è¾“å…¥ */
        .file-input {
            display: none;
        }

        /* é€‰æ‹©å™¨æ ·å¼ */
        select.form-input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236B7280' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div class="login-container" id="login-container">
        <div class="login-box">
            <div class="login-header">
                <div class="logo">ğŸ¬</div>
                <h1>è‹±è¯­é…éŸ³ä¹å›­</h1>
                <p>åå°ç®¡ç†ç³»ç»Ÿ</p>
            </div>
            <div class="login-error" id="login-error"></div>
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·å</label>
                    <input type="text" class="form-input" id="login-username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                </div>
                <div class="form-group">
                    <label class="form-label">å¯†ç </label>
                    <input type="password" class="form-input" id="login-password" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>
                <button type="submit" class="btn-login" id="btn-login">ç™»å½•</button>
            </form>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ -->
    <div class="app-container" id="app-container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <nav class="navbar">
            <h1>ğŸ¬ è‹±è¯­é…éŸ³ä¹å›­ - åå°ç®¡ç†</h1>
            <div class="navbar-right">
                <div class="navbar-stats" id="navbar-stats">
                    <div class="stat-item">
                        <span>åŠ¨ç”»ç‰‡:</span>
                        <span class="stat-value" id="stat-cartoons">0</span>
                    </div>
                    <div class="stat-item">
                        <span>é…éŸ³ç‰‡æ®µ:</span>
                        <span class="stat-value" id="stat-clips">0</span>
                    </div>
                    <div class="stat-item">
                        <span>é…éŸ³è®°å½•:</span>
                        <span class="stat-value" id="stat-records">0</span>
                    </div>
                </div>
                <div class="user-info">
                    <span>ğŸ‘¤ <span id="current-user">admin</span></span>
                    <button class="btn-logout" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </nav>

        <div class="main-container">
            <!-- ä¾§è¾¹æ  -->
            <aside class="sidebar">
                <ul class="sidebar-menu">
                    <li class="active" data-page="dashboard">
                        <span class="icon">ğŸ“Š</span>
                        <span>æ•°æ®æ¦‚è§ˆ</span>
                    </li>
                    <li data-page="cartoons">
                        <span class="icon">ğŸ¬</span>
                        <span>åŠ¨ç”»ç‰‡ç®¡ç†</span>
                    </li>
                    <li data-page="records">
                        <span class="icon">ğŸ“</span>
                        <span>é…éŸ³è®°å½•</span>
                    </li>
                </ul>
            </aside>

            <!-- ä¸»å†…å®¹åŒº -->
            <main class="content" id="content">
                <!-- å†…å®¹å°†é€šè¿‡ JS åŠ¨æ€åŠ è½½ -->
            </main>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title">æ ‡é¢˜</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- è¡¨å•å†…å®¹ -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="modal-submit">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="import-file" class="file-input" accept=".json" onchange="handleImportFile(event)">

    <script>
        // API åŸºç¡€åœ°å€
        const API_BASE = '';

        // å½“å‰é¡µé¢çŠ¶æ€
        let currentPage = 'dashboard';
        let allData = { cartoons: [], seasons: [] };
        let authToken = null;

        // ===== è®¤è¯ç›¸å…³ =====
        function getStoredToken() {
            return localStorage.getItem('admin_token');
        }

        function setStoredToken(token) {
            localStorage.setItem('admin_token', token);
        }

        function clearStoredToken() {
            localStorage.removeItem('admin_token');
        }

        function getAuthHeaders() {
            const token = authToken || getStoredToken();
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }

        async function checkAuth() {
            const token = getStoredToken();
            if (!token) {
                showLoginPage();
                return false;
            }

            try {
                const res = await fetch(`${API_BASE}/admin/verify`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    authToken = token;
                    document.getElementById('current-user').textContent = data.username;
                    showAppPage();
                    return true;
                } else {
                    clearStoredToken();
                    showLoginPage();
                    return false;
                }
            } catch (e) {
                console.error('éªŒè¯å¤±è´¥:', e);
                clearStoredToken();
                showLoginPage();
                return false;
            }
        }

        function showLoginPage() {
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('app-container').classList.remove('show');
        }

        function showAppPage() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('app-container').classList.add('show');
            loadStats();
            loadDashboard();
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            const btnLogin = document.getElementById('btn-login');
            
            btnLogin.disabled = true;
            btnLogin.textContent = 'ç™»å½•ä¸­...';
            errorEl.classList.remove('show');
            
            try {
                const formData = new FormData();
                formData.append('username', username);
                formData.append('password', password);
                
                const res = await fetch(`${API_BASE}/admin/login`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await res.json();
                
                if (res.ok && data.success) {
                    authToken = data.token;
                    setStoredToken(data.token);
                    document.getElementById('current-user').textContent = username;
                    showAppPage();
                } else {
                    errorEl.textContent = data.detail || 'ç™»å½•å¤±è´¥';
                    errorEl.classList.add('show');
                }
            } catch (e) {
                errorEl.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                errorEl.classList.add('show');
            } finally {
                btnLogin.disabled = false;
                btnLogin.textContent = 'ç™»å½•';
            }
        }

        async function handleLogout() {
            try {
                await fetch(`${API_BASE}/admin/logout`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
            } catch (e) {
                // å¿½ç•¥é”™è¯¯
            }
            
            authToken = null;
            clearStoredToken();
            showLoginPage();
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
        }

        // ===== é¡µé¢åˆ‡æ¢ =====
        document.querySelectorAll('.sidebar-menu li').forEach(item => {
            item.addEventListener('click', () => {
                const page = item.dataset.page;
                switchPage(page);
            });
        });

        function switchPage(page) {
            currentPage = page;
            document.querySelectorAll('.sidebar-menu li').forEach(li => {
                li.classList.toggle('active', li.dataset.page === page);
            });
            loadPage(page);
        }

        // åŠ è½½é¡µé¢å†…å®¹
        async function loadPage(page) {
            const content = document.getElementById('content');
            content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            switch (page) {
                case 'dashboard':
                    await loadDashboard();
                    break;
                case 'cartoons':
                    await loadCartoonsTree();
                    break;
                case 'records':
                    await loadRecords();
                    break;
            }
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/admin/stats`);
                const data = await res.json();
                document.getElementById('stat-cartoons').textContent = data.total_cartoons;
                document.getElementById('stat-clips').textContent = data.total_clips;
                document.getElementById('stat-records').textContent = data.total_records;
                return data;
            } catch (e) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', e);
            }
        }

        // åŠ è½½æ‰€æœ‰æ•°æ®
        async function loadAllData() {
            const [cartoons, seasons] = await Promise.all([
                fetch(`${API_BASE}/admin/cartoons`).then(r => r.json()),
                fetch(`${API_BASE}/admin/seasons`).then(r => r.json())
            ]);
            allData = { cartoons, seasons };
            return allData;
        }

        // æ•°æ®æ¦‚è§ˆé¡µé¢
        async function loadDashboard() {
            const stats = await loadStats();
            if (!stats) return;

            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="content-header">
                    <h2>ğŸ“Š æ•°æ®æ¦‚è§ˆ</h2>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #FEF3C7;">ğŸ¬</div>
                        <div class="stat-info">
                            <h3>${stats.total_cartoons}</h3>
                            <p>åŠ¨ç”»ç‰‡æ•°é‡</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #DBEAFE;">ğŸ“º</div>
                        <div class="stat-info">
                            <h3>${stats.total_seasons}</h3>
                            <p>å­£æ•°</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #D1FAE5;">ğŸï¸</div>
                        <div class="stat-info">
                            <h3>${stats.total_episodes}</h3>
                            <p>é›†æ•°</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #FCE7F3;">ğŸ¤</div>
                        <div class="stat-info">
                            <h3>${stats.total_clips}</h3>
                            <p>é…éŸ³ç‰‡æ®µ</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #E0E7FF;">ğŸ“</div>
                        <div class="stat-info">
                            <h3>${stats.total_records}</h3>
                            <p>é…éŸ³è®°å½•</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">â­ é¦–é¡µæ¨èç‰‡æ®µ</span>
                        <div class="header-actions">
                            <button class="btn btn-primary" onclick="generateRecommendations()">
                                ğŸ² éšæœºç”Ÿæˆ20ä¸ªæ¨è
                            </button>
                        </div>
                    </div>
                    <div id="recommendations-container">
                        <p style="color: var(--text-secondary); text-align: center; padding: 20px;">
                            ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆæ¨èç‰‡æ®µï¼Œæ‰€æœ‰ç”¨æˆ·é¦–é¡µå°†æ˜¾ç¤ºè¿™äº›ç‰‡æ®µ
                        </p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">ğŸ“ æœ€è¿‘é…éŸ³è®°å½•</span>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>ç‰‡æ®µID</th>
                                    <th>å¾—åˆ†</th>
                                    <th>åé¦ˆ</th>
                                    <th>æ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${stats.recent_records.map(r => `
                                    <tr>
                                        <td>${r.id}</td>
                                        <td>${r.clip_path || '-'}</td>
                                        <td><span class="badge ${r.score >= 70 ? 'badge-success' : 'badge-warning'}">${r.score || '-'}</span></td>
                                        <td>${r.feedback || '-'}</td>
                                        <td>${new Date(r.created_at).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // åŠ è½½å½“å‰æ¨èç‰‡æ®µ
            loadCurrentRecommendations();
        }

        // åŠ è½½å½“å‰æ¨èç‰‡æ®µ
        async function loadCurrentRecommendations() {
            const container = document.getElementById('recommendations-container');
            if (!container) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/recommendations`, {
                    headers: getAuthHeaders()
                });
                const clips = await res.json();
                
                if (clips.length === 0) {
                    container.innerHTML = `
                        <p style="color: var(--text-secondary); text-align: center; padding: 20px;">
                            æš‚æ— æ¨èç‰‡æ®µï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆ
                        </p>
                    `;
                } else {
                    container.innerHTML = `
                        <p style="color: var(--text-secondary); margin-bottom: 12px;">
                            å½“å‰å·²æœ‰ <strong>${clips.length}</strong> ä¸ªæ¨èç‰‡æ®µ
                        </p>
                        <div style="display: flex; flex-wrap: wrap; gap: 12px; max-height: 300px; overflow-y: auto;">
                            ${clips.map((clip, i) => `
                                <div style="background: var(--bg-secondary); border-radius: 8px; padding: 10px; width: calc(50% - 6px); display: flex; align-items: center; gap: 10px;">
                                    <img src="${clip.thumbnail || 'https://picsum.photos/60/40'}" 
                                         style="width: 60px; height: 40px; border-radius: 4px; object-fit: cover;"
                                         onerror="this.src='https://picsum.photos/60/40'">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 12px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                            ${clip.originalText || 'æ— æ–‡æœ¬'}
                                        </div>
                                        <div style="font-size: 11px; color: var(--text-secondary);">
                                            ${clip.episodeName.substring(0, 20)}...
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (e) {
                console.error('åŠ è½½æ¨èç‰‡æ®µå¤±è´¥:', e);
                container.innerHTML = `
                    <p style="color: var(--danger); text-align: center; padding: 20px;">
                        åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•
                    </p>
                `;
            }
        }

        // ç”Ÿæˆæ¨èç‰‡æ®µ
        async function generateRecommendations() {
            if (!confirm('ç¡®å®šè¦é‡æ–°ç”Ÿæˆæ¨èç‰‡æ®µå—ï¼Ÿè¿™å°†æ›¿æ¢å½“å‰æ‰€æœ‰æ¨èã€‚')) {
                return;
            }
            
            const container = document.getElementById('recommendations-container');
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="loading"></div>
                    <p style="color: var(--text-secondary); margin-top: 12px;">æ­£åœ¨ä»æ‰€æœ‰ç‰‡æ®µä¸­éšæœºé€‰æ‹©...</p>
                    <p style="color: var(--text-secondary); font-size: 12px;">è¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·ç¨å€™</p>
                </div>
            `;
            
            try {
                const res = await fetch(`${API_BASE}/admin/generate-recommendations?count=20`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    alert(`æˆåŠŸï¼${data.message}`);
                    loadCurrentRecommendations();
                } else {
                    alert('ç”Ÿæˆå¤±è´¥: ' + (data.detail || 'æœªçŸ¥é”™è¯¯'));
                    loadCurrentRecommendations();
                }
            } catch (e) {
                console.error('ç”Ÿæˆæ¨èç‰‡æ®µå¤±è´¥:', e);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                loadCurrentRecommendations();
            }
        }

        // åŠ¨ç”»ç‰‡æ ‘å½¢ç®¡ç†
        async function loadCartoonsTree() {
            await loadAllData();
            const { cartoons, seasons } = allData;

            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="content-header">
                    <h2>ğŸ¬ åŠ¨ç”»ç‰‡ç®¡ç†</h2>
                    <div class="header-actions">
                        <button class="btn btn-outline" onclick="exportData()">ğŸ“¤ å¯¼å‡ºJSON</button>
                        <button class="btn btn-outline" onclick="importData()">ğŸ“¥ å¯¼å…¥JSON</button>
                        <button class="btn btn-primary" onclick="showCartoonForm()">â• æ–°å¢åŠ¨ç”»ç‰‡</button>
                    </div>
                </div>
                
                <div class="card" style="margin-bottom: 20px; background: #FEF3C7; border-color: #F59E0B;">
                    <p style="margin: 0; color: #92400E;">
                        ğŸ’¡ <strong>æç¤ºï¼š</strong>å‹¾é€‰"ä¸Šé¦–é¡µ"åï¼Œè¯¥åŠ¨ç”»ç‰‡ä¼šæ˜¾ç¤ºåœ¨Appé¦–é¡µçš„çƒ­é—¨åŠ¨ç”»ä¸­ã€‚æ‹–æ‹½æˆ–ä½¿ç”¨ä¸Šä¸‹æŒ‰é’®è°ƒæ•´é¡ºåºã€‚
                    </p>
                </div>

                <div class="tree-container" id="cartoons-sortable">
                    ${cartoons.length === 0 ? '<div class="empty-state"><div class="icon">ğŸ¬</div><p>è¿˜æ²¡æœ‰åŠ¨ç”»ç‰‡ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </p></div>' : ''}
                    ${cartoons.map((cartoon, index) => {
                        const cartoonSeasons = seasons.filter(s => s.cartoon_id === cartoon.id).sort((a, b) => a.number - b.number);
                        return `
                            <div class="tree-item" data-id="${cartoon.id}" data-sort="${cartoon.sort_order || 0}" data-featured="${cartoon.is_featured ? '1' : '0'}">
                                <div class="tree-header" onclick="toggleTree(this)">
                                    <div class="sort-controls" onclick="event.stopPropagation()">
                                        <button class="btn-sort" onclick="moveCartoon('${cartoon.id}', -1)" title="ä¸Šç§»">â–²</button>
                                        <button class="btn-sort" onclick="moveCartoon('${cartoon.id}', 1)" title="ä¸‹ç§»">â–¼</button>
                                    </div>
                                    <label class="featured-checkbox" onclick="event.stopPropagation()" title="å‹¾é€‰åæ˜¾ç¤ºåœ¨é¦–é¡µ">
                                        <input type="checkbox" ${cartoon.is_featured ? 'checked' : ''} onchange="toggleFeatured('${cartoon.id}', this.checked)">
                                        <span>é¦–é¡µ</span>
                                    </label>
                                    <div class="tree-toggle ${cartoonSeasons.length > 0 ? '' : 'hidden'}">â–¶</div>
                                    <img class="thumbnail" src="${cartoon.thumbnail || 'https://via.placeholder.com/60x40'}" alt="">
                                    <div class="tree-info">
                                        <div class="tree-title">
                                            ${cartoon.name_cn}
                                            ${cartoon.is_featured ? '<span class="badge badge-warning" style="margin-left: 8px;">é¦–é¡µæ¨è</span>' : ''}
                                        </div>
                                        <div class="tree-subtitle">${cartoon.name} Â· ${cartoonSeasons.length}å­£ Â· <span class="badge ${cartoon.is_active ? 'badge-success' : 'badge-danger'}">${cartoon.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></div>
                                    </div>
                                    <div class="tree-actions" onclick="event.stopPropagation()">
                                        <button class="btn btn-outline btn-sm" onclick="showSeasonForm('${cartoon.id}')">â• å­£</button>
                                        <button class="btn btn-outline btn-sm" onclick="showCartoonForm('${cartoon.id}')">ç¼–è¾‘</button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteCartoon('${cartoon.id}')">åˆ é™¤</button>
                                    </div>
                                </div>
                                <div class="tree-children">
                                    ${cartoonSeasons.map(season => {
                                        return `
                                            <div class="tree-child" data-id="${season.id}">
                                                <div class="tree-header">
                                                    <span class="tree-icon">ğŸ“º</span>
                                                    <div class="tree-info">
                                                        <div class="tree-title">ç¬¬ ${season.number} å­£</div>
                                                        <div class="tree-subtitle">
                                                            ${season.all_json_url ? 'âœ… å·²é…ç½® JSON URL' : 'âš ï¸ æœªé…ç½® JSON URL'}
                                                            Â· <span class="badge ${season.is_active ? 'badge-success' : 'badge-danger'}">${season.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}</span>
                                                        </div>
                                                        ${season.all_json_url ? `<div class="tree-subtitle" style="font-size: 11px; word-break: break-all; max-width: 400px;">${season.all_json_url}</div>` : ''}
                                                    </div>
                                                    <div class="tree-actions" onclick="event.stopPropagation()">
                                                        <button class="btn btn-outline btn-sm" onclick="showSeasonFormEdit('${season.id}')">ç¼–è¾‘</button>
                                                        <button class="btn btn-danger btn-sm" onclick="deleteSeason('${season.id}')">åˆ é™¤</button>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // ç§»åŠ¨åŠ¨ç”»ç‰‡æ’åº
        async function moveCartoon(id, direction) {
            const container = document.getElementById('cartoons-sortable');
            const items = Array.from(container.querySelectorAll('.tree-item'));
            const currentIndex = items.findIndex(item => item.dataset.id === id);
            
            if (currentIndex === -1) return;
            
            const newIndex = currentIndex + direction;
            if (newIndex < 0 || newIndex >= items.length) return;
            
            // äº¤æ¢DOMä½ç½®
            const currentItem = items[currentIndex];
            const targetItem = items[newIndex];
            
            if (direction < 0) {
                container.insertBefore(currentItem, targetItem);
            } else {
                container.insertBefore(targetItem, currentItem);
            }
            
            // ä¿å­˜æ’åº
            await saveCartoonsOrder();
        }
        
        // åˆ‡æ¢é¦–é¡µæ˜¾ç¤º
        async function toggleFeatured(id, checked) {
            const item = document.querySelector(`.tree-item[data-id="${id}"]`);
            if (item) {
                item.dataset.featured = checked ? '1' : '0';
            }
            await saveCartoonsOrder();
            // é‡æ–°åŠ è½½ä»¥æ›´æ–°UIæ˜¾ç¤º
            loadCartoonsTree();
        }
        
        // ä¿å­˜æ’åºå’Œé¦–é¡µçŠ¶æ€
        async function saveCartoonsOrder() {
            const container = document.getElementById('cartoons-sortable');
            const items = Array.from(container.querySelectorAll('.tree-item'));
            
            const orders = items.map((item, index) => ({
                id: item.dataset.id,
                sort_order: index,
                is_featured: item.dataset.featured === '1'
            }));
            
            try {
                const res = await fetch(`${API_BASE}/admin/cartoons/update-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify(orders)
                });
                
                if (!res.ok) {
                    throw new Error('ä¿å­˜å¤±è´¥');
                }
                
                // æ›´æ–°æœ¬åœ°æ•°æ®
                await loadAllData();
            } catch (e) {
                console.error('ä¿å­˜æ’åºå¤±è´¥:', e);
                alert('ä¿å­˜æ’åºå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // åˆ‡æ¢æ ‘å½¢å±•å¼€/æŠ˜å 
        function toggleTree(header) {
            const toggle = header.querySelector('.tree-toggle');
            const parent = header.parentElement;
            const children = parent.querySelector('.tree-children, .tree-grandchildren, .tree-clips');
            
            if (children && !toggle.classList.contains('hidden')) {
                toggle.classList.toggle('expanded');
                children.classList.toggle('expanded');
            }
        }

        // å¯¼å‡ºæ•°æ®
        async function exportData() {
            try {
                const res = await fetch(`${API_BASE}/admin/export`);
                const data = await res.json();
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `peiyin_export_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                alert('å¯¼å‡ºæˆåŠŸï¼');
            } catch (e) {
                alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
            }
        }

        // å¯¼å…¥æ•°æ®
        function importData() {
            document.getElementById('import-file').click();
        }

        async function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const replace = confirm('æ˜¯å¦æ›¿æ¢ç°æœ‰æ•°æ®ï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"å°†åˆ é™¤æ‰€æœ‰ç°æœ‰æ•°æ®åå¯¼å…¥\nç‚¹å‡»"å–æ¶ˆ"å°†åªæ·»åŠ ä¸å­˜åœ¨çš„æ•°æ®');
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('replace', replace);
            
            try {
                const res = await fetch(`${API_BASE}/admin/import`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await res.json();
                
                if (res.ok) {
                    alert(`å¯¼å…¥æˆåŠŸï¼\nåŠ¨ç”»ç‰‡: ${result.imported.cartoons}\nå­£: ${result.imported.seasons}\né›†: ${result.imported.episodes}\nç‰‡æ®µ: ${result.imported.clips}`);
                    loadCartoonsTree();
                    loadStats();
                } else {
                    alert('å¯¼å…¥å¤±è´¥: ' + (result.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                alert('å¯¼å…¥å¤±è´¥: ' + e.message);
            }
            
            event.target.value = '';
        }

        // æ˜¾ç¤ºåŠ¨ç”»ç‰‡è¡¨å•
        async function showCartoonForm(id = null) {
            let cartoon = { id: '', name: '', name_cn: '', thumbnail: '', description: '', is_active: true };
            
            if (id) {
                const res = await fetch(`${API_BASE}/admin/cartoons/${id}`);
                cartoon = await res.json();
            }

            document.getElementById('modal-title').textContent = id ? 'ç¼–è¾‘åŠ¨ç”»ç‰‡' : 'æ–°å¢åŠ¨ç”»ç‰‡';
            document.getElementById('modal-body').innerHTML = `
                <div class="form-group">
                    <label class="form-label">IDï¼ˆå”¯ä¸€æ ‡è¯†ï¼Œå¦‚ï¼špeppa-pigï¼‰</label>
                    <input type="text" class="form-input" id="form-id" value="${cartoon.id}" ${id ? 'disabled' : ''}>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ä¸­æ–‡å</label>
                        <input type="text" class="form-input" id="form-name-cn" value="${cartoon.name_cn}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">è‹±æ–‡å</label>
                        <input type="text" class="form-input" id="form-name" value="${cartoon.name}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ç¼©ç•¥å›¾URL</label>
                    <input type="text" class="form-input" id="form-thumbnail" value="${cartoon.thumbnail || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">æè¿°</label>
                    <textarea class="form-input" id="form-description">${cartoon.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="form-active" ${cartoon.is_active ? 'checked' : ''}> å¯ç”¨
                    </label>
                </div>
            `;

            document.getElementById('modal-submit').onclick = () => saveCartoon(id);
            openModal();
        }

        // ä¿å­˜åŠ¨ç”»ç‰‡
        async function saveCartoon(id) {
            const data = {
                id: document.getElementById('form-id').value,
                name: document.getElementById('form-name').value,
                name_cn: document.getElementById('form-name-cn').value,
                thumbnail: document.getElementById('form-thumbnail').value,
                description: document.getElementById('form-description').value,
                is_active: document.getElementById('form-active').checked
            };

            const url = id ? `${API_BASE}/admin/cartoons/${id}` : `${API_BASE}/admin/cartoons`;
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    closeModal();
                    loadCartoonsTree();
                    loadStats();
                } else {
                    const err = await res.json();
                    alert('ä¿å­˜å¤±è´¥: ' + (err.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥: ' + e.message);
            }
        }

        // åˆ é™¤åŠ¨ç”»ç‰‡
        async function deleteCartoon(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåŠ¨ç”»ç‰‡å—ï¼Ÿç›¸å…³çš„å­£ã€é›†ã€é…éŸ³ç‰‡æ®µéƒ½ä¼šè¢«åˆ é™¤ï¼')) return;

            try {
                const res = await fetch(`${API_BASE}/admin/cartoons/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadCartoonsTree();
                    loadStats();
                }
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }

        // æ˜¾ç¤ºå­£è¡¨å•
        function showSeasonForm(cartoonId) {
            document.getElementById('modal-title').textContent = 'æ–°å¢å­£';
            document.getElementById('modal-body').innerHTML = `
                <div class="form-group">
                    <label class="form-label">IDï¼ˆå¦‚ï¼špeppa-s1ï¼‰</label>
                    <input type="text" class="form-input" id="form-id" value="${cartoonId}-s${Date.now() % 100}">
                </div>
                <input type="hidden" id="form-cartoon-id" value="${cartoonId}">
                <div class="form-group">
                    <label class="form-label">å­£æ•°</label>
                    <input type="number" class="form-input" id="form-number" value="1" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">all.json URL</label>
                    <input type="text" class="form-input" id="form-all-json-url" placeholder="å¦‚: https://example.com/videos/peppa/s1/all.json">
                    <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                        all.json åŒ…å«è¯¥å­£æ‰€æœ‰é›†çš„ä¿¡æ¯ï¼Œæ ¼å¼: [{"id": 0, "name": "ç›®å½•åç§°"}, ...]
                    </p>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="form-active" checked> å¯ç”¨
                    </label>
                </div>
            `;

            document.getElementById('modal-submit').onclick = () => saveSeason(null);
            openModal();
        }

        async function showSeasonFormEdit(id) {
            const season = allData.seasons.find(s => s.id === id);
            if (!season) return;

            document.getElementById('modal-title').textContent = 'ç¼–è¾‘å­£';
            document.getElementById('modal-body').innerHTML = `
                <div class="form-group">
                    <label class="form-label">ID</label>
                    <input type="text" class="form-input" id="form-id" value="${season.id}" disabled>
                </div>
                <input type="hidden" id="form-cartoon-id" value="${season.cartoon_id}">
                <div class="form-group">
                    <label class="form-label">å­£æ•°</label>
                    <input type="number" class="form-input" id="form-number" value="${season.number}" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">all.json URL</label>
                    <input type="text" class="form-input" id="form-all-json-url" value="${season.all_json_url || ''}" placeholder="å¦‚: https://example.com/videos/peppa/s1/all.json">
                    <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                        all.json åŒ…å«è¯¥å­£æ‰€æœ‰é›†çš„ä¿¡æ¯ï¼Œæ ¼å¼: [{"id": 0, "name": "ç›®å½•åç§°"}, ...]
                    </p>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="form-active" ${season.is_active ? 'checked' : ''}> å¯ç”¨
                    </label>
                </div>
            `;

            document.getElementById('modal-submit').onclick = () => saveSeason(id);
            openModal();
        }

        // ä¿å­˜å­£
        async function saveSeason(id) {
            const data = {
                id: document.getElementById('form-id').value,
                cartoon_id: document.getElementById('form-cartoon-id').value,
                number: parseInt(document.getElementById('form-number').value),
                all_json_url: document.getElementById('form-all-json-url').value || null,
                is_active: document.getElementById('form-active').checked
            };

            const url = id ? `${API_BASE}/admin/seasons/${id}` : `${API_BASE}/admin/seasons`;
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    closeModal();
                    loadCartoonsTree();
                    loadStats();
                } else {
                    const err = await res.json();
                    alert('ä¿å­˜å¤±è´¥: ' + (err.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥: ' + e.message);
            }
        }

        // åˆ é™¤å­£
        async function deleteSeason(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸€å­£å—ï¼Ÿç›¸å…³çš„é›†å’Œé…éŸ³ç‰‡æ®µéƒ½ä¼šè¢«åˆ é™¤ï¼')) return;

            try {
                const res = await fetch(`${API_BASE}/admin/seasons/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadCartoonsTree();
                    loadStats();
                }
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }

        // æ˜¾ç¤ºé›†è¡¨å•
        function showEpisodeForm(seasonId) {
            document.getElementById('modal-title').textContent = 'æ–°å¢é›†';
            document.getElementById('modal-body').innerHTML = `
                <div class="form-group">
                    <label class="form-label">IDï¼ˆå¦‚ï¼špeppa-s1-e1ï¼‰</label>
                    <input type="text" class="form-input" id="form-id" value="${seasonId}-e${Date.now() % 100}">
                </div>
                <input type="hidden" id="form-season-id" value="${seasonId}">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">é›†æ•°</label>
                        <input type="number" class="form-input" id="form-number" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="form-active" checked> å¯ç”¨
                        </label>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ä¸­æ–‡æ ‡é¢˜</label>
                        <input type="text" class="form-input" id="form-title-cn" value="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">è‹±æ–‡æ ‡é¢˜</label>
                        <input type="text" class="form-input" id="form-title" value="">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ç¼©ç•¥å›¾URL</label>
                    <input type="text" class="form-input" id="form-thumbnail" value="">
                </div>
            `;

            document.getElementById('modal-submit').onclick = () => saveEpisode(null);
            openModal();
        }

        async function showEpisodeFormEdit(id) {
            const episode = allData.episodes.find(e => e.id === id);
            if (!episode) return;

            document.getElementById('modal-title').textContent = 'ç¼–è¾‘é›†';
            document.getElementById('modal-body').innerHTML = `
                <div class="form-group">
                    <label class="form-label">ID</label>
                    <input type="text" class="form-input" id="form-id" value="${episode.id}" disabled>
                </div>
                <input type="hidden" id="form-season-id" value="${episode.season_id}">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">é›†æ•°</label>
                        <input type="number" class="form-input" id="form-number" value="${episode.number}" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="form-active" ${episode.is_active ? 'checked' : ''}> å¯ç”¨
                        </label>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ä¸­æ–‡æ ‡é¢˜</label>
                        <input type="text" class="form-input" id="form-title-cn" value="${episode.title_cn || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">è‹±æ–‡æ ‡é¢˜</label>
                        <input type="text" class="form-input" id="form-title" value="${episode.title || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ç¼©ç•¥å›¾URL</label>
                    <input type="text" class="form-input" id="form-thumbnail" value="${episode.thumbnail || ''}">
                </div>
            `;

            document.getElementById('modal-submit').onclick = () => saveEpisode(id);
            openModal();
        }

        // ä¿å­˜é›†
        async function saveEpisode(id) {
            const data = {
                id: document.getElementById('form-id').value,
                season_id: document.getElementById('form-season-id').value,
                number: parseInt(document.getElementById('form-number').value),
                title: document.getElementById('form-title').value,
                title_cn: document.getElementById('form-title-cn').value,
                thumbnail: document.getElementById('form-thumbnail').value,
                is_active: document.getElementById('form-active').checked
            };

            const url = id ? `${API_BASE}/admin/episodes/${id}` : `${API_BASE}/admin/episodes`;
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    closeModal();
                    loadCartoonsTree();
                    loadStats();
                } else {
                    const err = await res.json();
                    alert('ä¿å­˜å¤±è´¥: ' + (err.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥: ' + e.message);
            }
        }

        // åˆ é™¤é›†
        async function deleteEpisode(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸€é›†å—ï¼Ÿç›¸å…³çš„é…éŸ³ç‰‡æ®µéƒ½ä¼šè¢«åˆ é™¤ï¼')) return;

            try {
                const res = await fetch(`${API_BASE}/admin/episodes/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadCartoonsTree();
                    loadStats();
                }
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }

        // æ˜¾ç¤ºç‰‡æ®µè¡¨å•
        function showClipForm(episodeId) {
            document.getElementById('modal-title').textContent = 'æ–°å¢é…éŸ³ç‰‡æ®µ';
            document.getElementById('modal-body').innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ID</label>
                        <input type="text" class="form-input" id="form-id" value="clip-${Date.now()}">
                    </div>
                    <input type="hidden" id="form-episode-id" value="${episodeId}">
                    <div class="form-group">
                        <label class="form-label">é¡ºåº</label>
                        <input type="number" class="form-input" id="form-order" value="1" min="1">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">è§’è‰²å</label>
                    <input type="text" class="form-input" id="form-character" value="">
                </div>
                <div class="form-group">
                    <label class="form-label">åŸæ–‡ï¼ˆè‹±æ–‡ï¼‰</label>
                    <textarea class="form-input" id="form-original-text"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">ä¸­æ–‡ç¿»è¯‘</label>
                    <textarea class="form-input" id="form-translation-cn"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">è§†é¢‘URL</label>
                    <input type="text" class="form-input" id="form-video-url" value="">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">å¼€å§‹æ—¶é—´(ç§’)</label>
                        <input type="number" class="form-input" id="form-start-time" value="0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç»“æŸæ—¶é—´(ç§’)</label>
                        <input type="number" class="form-input" id="form-end-time" value="5" step="0.1">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="form-active" checked> å¯ç”¨
                    </label>
                </div>
            `;

            document.getElementById('modal-submit').onclick = () => saveClip(null);
            openModal();
        }

        async function showClipFormEdit(id) {
            const clip = allData.clips.find(c => c.id === id);
            if (!clip) return;

            document.getElementById('modal-title').textContent = 'ç¼–è¾‘é…éŸ³ç‰‡æ®µ';
            document.getElementById('modal-body').innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ID</label>
                        <input type="text" class="form-input" id="form-id" value="${clip.id}" disabled>
                    </div>
                    <input type="hidden" id="form-episode-id" value="${clip.episode_id}">
                    <div class="form-group">
                        <label class="form-label">é¡ºåº</label>
                        <input type="number" class="form-input" id="form-order" value="${clip.order}" min="1">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">è§’è‰²å</label>
                    <input type="text" class="form-input" id="form-character" value="${clip.character || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">åŸæ–‡ï¼ˆè‹±æ–‡ï¼‰</label>
                    <textarea class="form-input" id="form-original-text">${clip.original_text}</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">ä¸­æ–‡ç¿»è¯‘</label>
                    <textarea class="form-input" id="form-translation-cn">${clip.translation_cn || ''}</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">è§†é¢‘URL</label>
                    <input type="text" class="form-input" id="form-video-url" value="${clip.video_url || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">å¼€å§‹æ—¶é—´(ç§’)</label>
                        <input type="number" class="form-input" id="form-start-time" value="${clip.start_time}" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç»“æŸæ—¶é—´(ç§’)</label>
                        <input type="number" class="form-input" id="form-end-time" value="${clip.end_time}" step="0.1">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="form-active" ${clip.is_active ? 'checked' : ''}> å¯ç”¨
                    </label>
                </div>
            `;

            document.getElementById('modal-submit').onclick = () => saveClip(id);
            openModal();
        }

        // ä¿å­˜ç‰‡æ®µ
        async function saveClip(id) {
            const data = {
                id: document.getElementById('form-id').value,
                episode_id: document.getElementById('form-episode-id').value,
                order: parseInt(document.getElementById('form-order').value),
                character: document.getElementById('form-character').value,
                original_text: document.getElementById('form-original-text').value,
                translation_cn: document.getElementById('form-translation-cn').value,
                video_url: document.getElementById('form-video-url').value,
                start_time: parseFloat(document.getElementById('form-start-time').value),
                end_time: parseFloat(document.getElementById('form-end-time').value),
                is_active: document.getElementById('form-active').checked
            };

            const url = id ? `${API_BASE}/admin/clips/${id}` : `${API_BASE}/admin/clips`;
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    closeModal();
                    loadCartoonsTree();
                    loadStats();
                } else {
                    const err = await res.json();
                    alert('ä¿å­˜å¤±è´¥: ' + (err.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥: ' + e.message);
            }
        }

        // åˆ é™¤ç‰‡æ®µ
        async function deleteClip(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé…éŸ³ç‰‡æ®µå—ï¼Ÿ')) return;

            try {
                const res = await fetch(`${API_BASE}/admin/clips/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadCartoonsTree();
                    loadStats();
                }
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }

        // é…éŸ³è®°å½•
        async function loadRecords() {
            const res = await fetch(`${API_BASE}/admin/records`);
            const records = await res.json();

            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="content-header">
                    <h2>ğŸ“ é…éŸ³è®°å½•</h2>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>ç‰‡æ®µè·¯å¾„</th>
                                    <th>ç”¨æˆ·ID</th>
                                    <th>å¾—åˆ†</th>
                                    <th>åé¦ˆ</th>
                                    <th>æ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${records.length === 0 ? '<tr><td colspan="7" class="empty-state">æš‚æ— é…éŸ³è®°å½•</td></tr>' : ''}
                                ${records.map(r => `
                                    <tr>
                                        <td>${r.id}</td>
                                        <td style="max-width: 200px; word-break: break-all; font-size: 12px;">${r.clip_path || '-'}</td>
                                        <td>${r.user_id || '-'}</td>
                                        <td><span class="badge ${r.score >= 70 ? 'badge-success' : 'badge-warning'}">${r.score || '-'}</span></td>
                                        <td>${r.feedback || '-'}</td>
                                        <td>${new Date(r.created_at).toLocaleString()}</td>
                                        <td class="action-btns">
                                            <button class="btn btn-danger btn-sm" onclick="deleteRecord(${r.id})">åˆ é™¤</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // åˆ é™¤è®°å½•
        async function deleteRecord(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡é…éŸ³è®°å½•å—ï¼Ÿ')) return;

            try {
                const res = await fetch(`${API_BASE}/admin/records/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadRecords();
                    loadStats();
                }
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }

        // æ¨¡æ€æ¡†æ§åˆ¶
        function openModal() {
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // åˆå§‹åŒ– - æ£€æŸ¥è®¤è¯çŠ¶æ€
        checkAuth();
    </script>
</body>
</html>
